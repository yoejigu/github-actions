name: Pulumi
on:
  push:
    branches:
      - esc-integration
jobs:
  up:
    name: Update
    runs-on: ubuntu-latest
    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v3

      - name: Setup Node JS ‚ú®
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Installing dependencies üì¶Ô∏è
        run: npm install

      - name: Authenticate with Pulumi Cloud
        uses: pulumi/auth-actions@v1
        with:
          organization: pulumi
          request-token-type: urn:pulumi:token-type:access_token:organization
        
      - name: Install and inject ESC Evironment Variables
        uses: pulumi/esc-action@v1
        with:
          environment: 'demo/cloud-access/aws-oidc'

      - name: Verify environment variables were injected
        run: |
          echo "TESTING ENV INJECTION"
          echo "Region = $AWS_REGION" 

      - name: Applying infrastructure üöÄ
        uses: pulumi/actions@v4
        with:
          command: up
          stack-name: dev
        # env:
        #   PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        #   AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY_ID}}
        #   AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}
        #   AWS_SESSION_TOKEN: ${{secrets.AWS_SESSION_TOKEN}}
